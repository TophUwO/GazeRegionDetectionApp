<html>
    <head>
        <title>Gaze Region Classification</title>
    </head>
    <body>
        <div class="page" id="pageWelcome">
            <div class="divOuterContainer" id="divWelcome">
                <button id="btnCreateSession">Create Session</button>

                <div class="sessionMngtForm">
                    <input type="text" id="inpSessionToken" placeholder="6-digit session token"></input>
                    <button id="btnJoinSession">Join Session</button>
                </div>
            </div>
        </div>
        <div class="page" id="pageCodeDisplay">
            <h1 id="lblCodeDisplay"></h1>
        </div>
        <div class="page" id="pageSessionReady">
            <h1 id="lblSessionReady">Session ready. Press 'Start' to start data collection.</h1>

            <button id="btnStartAll">Start</button>
        </div>
        <div class="page" id="pageStageInterm">
            <h1 id="lblSessionInterm">Stage completed. Press 'Continue' to advance to the next stage.</h1>

            <button id="btnContinue">Continue</button>
        </div>
        <div class="page" id="pageIdle">
            <h1>Screen is idle. Shit is happening on the other screen.</h1>
        </div>
        <div class="page" id="pageShowInstInter">
            <h1>Instructions</h1>
            Instructions.<br>
            Press 'Start' to start data collection.

            <button id="btnStart">Start</button>
        </div>
        <div class="page" id="pageShowInst">
            <h1>Instructions</h1>
            Instructions<br>
            Do the stuff.
        </div>
        <div class="page" id="pageStage1">
            <h1>Stage 1</h1>
        </div>
        <div class="page" id="pageStage2">
            <h1>Stage 2</h1>
        </div>
        <div class="page" id="pageStage3">
            <h1>Stage 3</h1>
        </div>
        <div class="page" id="pageStage4">
            <h1>Stage 4</h1>
        </div>
        <div class="page" id="pageFatalError">
            <h1>A fatal error occurred. Please refresh the page and start anew.</h1>
        </div>
        <div class="page" id="pageFinished">
            <h1>Fini</h1>
        </div>

        <script>
            let webSocket = null // websocket for comms
            let roleId    = ''   // ID of this client's role
            let stageId   = 0    // ID of the current stage
            let currPage  = null // currently-active page element
            let sessCode  = ''   // session code
            let submIval  = null // submission interval object

            stages = {
                'stage0': { 'H': 'pageWelcome',       'L': 'pageWelcome',       'time': 0       }, // prep, unused
                'stage1': { 'H': 'pageShowInstInter', 'L': 'pageIdle',          'time': 0       }, // show inst 1
                'stage2': { 'H': 'pageStage1',        'L': 'pageShowInst',      'time': 5 * 1   }, // coll 1
                'stage3': { 'H': 'pageShowInstInter', 'L': 'pageIdle',          'time': 0       }, // show inst 2
                'stage4': { 'H': 'pageStage2',        'L': 'pageShowInst',      'time': 5 * 1   }, // coll 2
                'stage5': { 'H': 'pageIdle',          'L': 'pageShowInstInter', 'time': 0       }, // show inst 3
                'stage6': { 'H': 'pageShowInst',      'L': 'pageStage3',        'time': 5 * 1   }, // coll 3
                'stage7': { 'H': 'pageShowInstInter', 'L': 'pageIdle',          'time': 0       }, // show inst 4
                'stage8': { 'H': 'pageStage4',        'L': 'pageStage4',        'time': 10 * 1  }, // coll 4
                'stage9': { 'H': 'pageFinished',      'L': 'pageFinished',      'time': 0       }  // fini
            };

            function switchToPage(pageName) {
                // Hide the current page.
                if (currPage != null) {
                    currPage.style.display = 'none'
                }

                // Show the next page.
                currPage = document.getElementById(pageName)
                if (currPage == null) {
                    currPage = document.getElementById('pageFatalError')
                }
                currPage.style.display = 'block'
            }

            function setupWebsocket() {
                // Open websocket.
                webSocket = new WebSocket(`ws://${location.host}/ws/${sessCode}/${roleId}`)
                {
                    webSocket.onopen    = wsOnOpen
                    webSocket.onmessage = wsOnMessage
                }
            }

            function wsOnOpen() {
                webSocket.send(JSON.stringify({ 'message': `hello from role ${roleId}` }))
            }

            function wsOnMessage(event) {
                response = JSON.parse(event.data)

                switch (response.command) {
                    case 'ready':
                        switchToPage('pageSessionReady')

                        break
                    case 'start_stage':
                        context = stages[`stage${response.value}`]
                        {
                            // Switch page.
                            switchToPage(context[roleId])

                            // If interactive, we set a timer for the session end and we also start the interval for the 
                            // submission of the images.
                            if (context.time != 0) {
                                // Set timeout timer.
                                setTimeout(() => {
                                    if (submIval != -1)
                                        clearInterval(submIval)

                                    switchToPage('pageStageInterm')
                                }, context.time * 1000)

                                // Set submission interval, but only for the upper tablet.
                                if (roleId == 'H')
                                    submIval = setInterval(async() => {
                                        console.log('took photo')

                                        await fetch(`/api/submit/${sessCode}`, { method: 'POST' })
                                    }, (1.0/3.0)*1000.0)
                                else
                                    submIval = -1
                            }
                        }
                        break
                }
            }

            document.getElementById('btnCreateSession').addEventListener('click', async() => {
                // Create new session.
                const response = await fetch('/api/create', { method: 'POST' })
                const data     = await response.json()
                
                if (data.type == 'ok') {
                    // Set state.
                    switchToPage('pageCodeDisplay')
                    {
                        roleId   = 'H'
                        sessCode = data.payload.code

                        // Show code.
                        document.getElementById('lblCodeDisplay').innerHTML = `Code: ${sessCode}`
                    }

                    // Open websocket.
                    setupWebsocket()
                }
            })

            document.getElementById('btnJoinSession').addEventListener('click', async() => {
                // Get token from form.
                sessCode = document.getElementById('inpSessionToken').value
                
                if (sessCode != null && sessCode != '') {
                    const response = await fetch(`/api/join?code=${sessCode}`, { method: 'POST' })
                    const data     = await response.json()

                    if (data.type == 'ok') {
                        // Set state.
                        switchToPage('pageIdle')
                        {
                            roleId = 'L'
                        }

                        // Open websocket.
                        setupWebsocket()
                    }
                }
            })

            document.getElementById('btnStartAll').addEventListener('click', async() => {
                await fetch(`api/advance/${sessCode}`, { method: 'POST' })
            })

            document.getElementById('btnStart').addEventListener('click', async() => {
                await fetch(`api/advance/${sessCode}`, { method: 'POST' })
            })

            document.getElementById('btnContinue').addEventListener('click', async() => {
                await fetch(`api/advance/${sessCode}`, { method: 'POST' })
            })

            // Switch to welcome page so that we can do stuff.
            switchToPage('pageWelcome')
        </script>
        <style>
            html, body {
                height:           100%;
                margin:           0;
                font-family:      Arial, sans-serif;
                display:          flex;
                justify-content:  center;
                align-items:      center;
                color:            white;
                background-color: rgb(11, 11, 11);
            }

            .divOuterContainer {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 10px;
                padding: 30px 40px;
                border-radius: 10px;
                border-width: 2px;
                border-color: black;
                margin: 3px;
                box-shadow: 0 0 10px rgba(0,0,0,0.1);
                background-color: rgb(33, 33 ,33);
            }

            #lblCouldNotCreateSes, #lblCouldNotJoinSes, #lblEmptyToken {
                display: none;
                color:   red;
            }

            #lblCodeDisplay, h1 {
                display: block;
                color: white;
            }

            #lblSessionReady {
                display: block;
                color: green;
            }

            .page {
                display: none;
            }
        </style>
    </body>
</html>


